<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="finder-wohnen.css">
</head>
<body>
<section class="immo-search-hero">
    <div class="immo-search-hero__container">
        <search class="immo-search">
            <h1 class="immo-search__title">Ihr neues Zuhause finden</h1>

            <form class="immo-search__form" id="searchForm" aria-label="Immobiliensuche">
                <!-- Transaction Type Switcher (Tab pattern for accessibility) -->
                <div class="immo-search__switcher" id="switcher" role="tablist" aria-label="Transaktionsart wählen">
                    <span class="immo-search__switcher-indicator" id="switcherIndicator" aria-hidden="true"></span>
                    <button
                            type="button"
                            role="tab"
                            class="immo-search__switcher-button immo-search__switcher-button--active"
                            data-value="mieten"
                            aria-selected="true"
                            tabindex="0"
                    >
                        Mieten
                    </button>
                    <button
                            type="button"
                            role="tab"
                            class="immo-search__switcher-button"
                            data-value="kaufen"
                            aria-selected="false"
                            tabindex="-1"
                    >
                        Kaufen
                    </button>
                    <input type="hidden" name="transactionType" id="transactionType" value="mieten">
                </div>

                <div class="immo-search__inputs">
                    <div class="immo-search__dropdown" id="propertyTypeDropdown">
                        <button
                                type="button"
                                class="immo-search__dropdown-trigger"
                                id="propertyTypeTrigger"
                                aria-haspopup="listbox"
                                aria-expanded="false"
                                aria-labelledby="propertyTypeLabel"
                                aria-controls="propertyTypeList"
                        >
                            <svg class="immo-search__dropdown-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 22V12h6v10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span class="immo-search__dropdown-value" id="propertyTypeValue">Wohnung</span>
                            <svg class="immo-search__dropdown-arrow" viewBox="0 0 24 24" aria-hidden="true">
                                <path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/>
                            </svg>
                        </button>
                        <span id="propertyTypeLabel" class="immo-search__sr-only">Immobilientyp</span>
                        <ul
                                class="immo-search__dropdown-list"
                                id="propertyTypeList"
                                role="listbox"
                                aria-labelledby="propertyTypeLabel"
                                tabindex="-1"
                        >
                            <!-- Options populated dynamically -->
                        </ul>
                        <input type="hidden" name="propertyType" id="propertyType" value="wohnung">
                    </div>

                    <!-- Location/Zipcode Input -->
                    <div class="immo-search__input-group">
                        <svg class="immo-search__input-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <label for="zipCode" class="immo-search__sr-only">Ort oder Postleitzahl</label>
                        <input
                                type="text"
                                id="zipCode"
                                name="zipCode"
                                class="immo-search__input"
                                placeholder=""
                                autocomplete="postal-code"
                                aria-describedby="zipCodeError"
                        >
                        <!-- Live region for error announcements -->
                        <span id="zipCodeError" class="immo-search__sr-only" role="alert" aria-live="assertive"></span>
                    </div>

                    <button type="submit" class="immo-search__search-button">
                        <svg class="immo-search__search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="m21 21-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="immo-search__search-text">Suchen</span>
                    </button>
                </div>

            </form>
        </search>
    </div>
</section>

<script>
  /**
   * Immobilien Search Component JavaScript
   *
   * Features:
   * - Animated tab switcher (Mieten/Kaufen)
   * - Custom accessible dropdown for property types
   * - Animated placeholder with typing effect
   * - Form validation with screen reader announcements
   *
   * Accessibility:
   * - ARIA roles and states for all interactive elements
   * - Keyboard navigation (Tab, Enter, Arrows, Escape)
   * - Live region for error announcements
   */

  // Property type options for rent and buy with icons (SVG path data)
  const propertyOptions = {
    mieten: [
      { value: 'wohnung', label: 'Wohnung', icon: '<rect x="4" y="2" width="16" height="20" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M9 6h2M13 6h2M9 10h2M13 10h2M9 14h2M13 14h2M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>' },
      { value: 'haus', label: 'Haus', icon: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M9 22V12h6v10" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'waz', label: 'Wohnen auf Zeit', icon: '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'wg', label: 'WG Zimmer', icon: '<path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" fill="none"/><path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" fill="none"/><path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'freizeit', label: 'Ferienimmobilie', icon: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="14" r="2" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'garage_stellplatz', label: 'Garage/Stellplatz', icon: '<rect x="3" y="11" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'grundstueck', label: 'Grundstück', icon: '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'sonstiges', label: 'Sonstiges', icon: '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="17" r="0.5" fill="currentColor"/>' }
    ],
    kaufen: [
      { value: 'haus', label: 'Haus', icon: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none"/><path d="M9 22V12h6v10" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'wohnung', label: 'Wohnung', icon: '<rect x="4" y="2" width="16" height="20" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M9 6h2M13 6h2M9 10h2M13 10h2M9 14h2M13 14h2M9 18h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>' },
      { value: 'grundstueck', label: 'Grundstück', icon: '<path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'freizeit', label: 'Ferienimmobilie', icon: '<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="14" r="2" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'renditeobjekt', label: 'Renditeobjekt', icon: '<path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'garage_stellplatz', label: 'Garage/Stellplatz', icon: '<rect x="3" y="11" width="18" height="10" rx="2" stroke="currentColor" stroke-width="2" fill="none"/><path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2" fill="none"/>' },
      { value: 'sonstiges', label: 'Sonstiges', icon: '<circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" stroke="currentColor" stroke-width="2" fill="none"/><circle cx="12" cy="17" r="0.5" fill="currentColor"/>' }
    ]
  };

  document.addEventListener('DOMContentLoaded', function() {
    const switcher = document.getElementById('switcher');
    const switcherButtons = document.querySelectorAll('.immo-search__switcher-button');
    const transactionTypeInput = document.getElementById('transactionType');

    const dropdown = document.getElementById('propertyTypeDropdown');
    const dropdownTrigger = document.getElementById('propertyTypeTrigger');
    const dropdownList = document.getElementById('propertyTypeList');
    const dropdownValue = document.getElementById('propertyTypeValue');
    const propertyTypeInput = document.getElementById('propertyType');

    const zipCodeInput = document.getElementById('zipCode');
    const form = document.getElementById('searchForm');

    let focusedIndex = -1;
    let currentTransactionType = 'mieten';

    // ========================================
    // SWITCHER FUNCTIONALITY
    // Implements an animated sliding indicator behind the active tab.
    // Uses CSS custom properties for smooth transitions.
    // ========================================

    /**
     * Positions the sliding indicator to match the active button.
     * Calculates offset relative to switcher container, accounting for padding.
     * @param {HTMLElement} activeButton - The currently active switcher button
     */
    function positionIndicator(activeButton) {
      const switcherRect = switcher.getBoundingClientRect();
      const buttonRect = activeButton.getBoundingClientRect();
      // Subtract 4px (switcher padding) to align indicator with button
      const offset = buttonRect.left - switcherRect.left - 4;

      switcher.style.setProperty('--switcher-indicator-width', `${buttonRect.width}px`);
      switcher.style.setProperty('--switcher-indicator-offset', `${offset}px`);
    }

    // Initialize switcher after fonts are loaded to prevent layout shift
    function initSwitcher() {
      const initialActiveButton = document.querySelector('.immo-search__switcher-button--active');
      if (initialActiveButton) {
        positionIndicator(initialActiveButton);
      }

      // Enable transitions after initial render (prevents animation on page load)
      requestAnimationFrame(() => {
        switcher.classList.add('immo-search__switcher--ready');
      });
    }

    // Wait for fonts to load before positioning indicator
    if (document.fonts && document.fonts.ready) {
      document.fonts.ready.then(initSwitcher);
    } else {
      initSwitcher();
    }

    switcherButtons.forEach(button => {
      button.addEventListener('click', function() {
        switcherButtons.forEach(btn => {
          btn.classList.remove('immo-search__switcher-button--active');
          btn.setAttribute('aria-selected', 'false');
          btn.setAttribute('tabindex', '-1');
        });
        this.classList.add('immo-search__switcher-button--active');
        this.setAttribute('aria-selected', 'true');
        this.setAttribute('tabindex', '0');
        positionIndicator(this);

        currentTransactionType = this.getAttribute('data-value');
        transactionTypeInput.value = currentTransactionType;

        // Update dropdown options
        renderOptions(currentTransactionType);
      });

      // Keyboard navigation for tabs (Arrow keys)
      button.addEventListener('keydown', function(e) {
        const buttons = Array.from(switcherButtons);
        const currentIndex = buttons.indexOf(this);
        let nextIndex;

        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          e.preventDefault();
          nextIndex = (currentIndex + 1) % buttons.length;
          buttons[nextIndex].click();
          buttons[nextIndex].focus();
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          nextIndex = (currentIndex - 1 + buttons.length) % buttons.length;
          buttons[nextIndex].click();
          buttons[nextIndex].focus();
        }
      });
    });

    // Debounce utility for performance optimization
    function debounce(fn, delay) {
      let timeoutId;
      return function(...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    // Debounced resize handler to prevent excessive recalculations
    const handleResize = debounce(() => {
      const activeButton = document.querySelector('.immo-search__switcher-button--active');
      if (activeButton) {
        positionIndicator(activeButton);
      }
    }, 100);

    window.addEventListener('resize', handleResize, { passive: true });

    // ========================================
    // CUSTOM DROPDOWN FUNCTIONALITY
    // ========================================

    function renderOptions(transactionType) {
      const options = propertyOptions[transactionType];
      const fragment = document.createDocumentFragment();

      options.forEach((option, index) => {
        const li = document.createElement('li');
        const optionId = `property-option-${option.value}`;
        li.id = optionId;
        li.className = 'immo-search__dropdown-option';
        if (index === 0) {
          li.className += ' immo-search__dropdown-option--selected';
        }
        li.setAttribute('role', 'option');
        li.setAttribute('data-value', option.value);
        li.setAttribute('aria-selected', index === 0 ? 'true' : 'false');

        li.innerHTML = `
          <svg class="immo-search__dropdown-option-icon" viewBox="0 0 24 24" aria-hidden="true">
            ${option.icon}
          </svg>
          <span>${option.label}</span>
        `;

        li.addEventListener('click', () => selectOption(option, li));
        fragment.appendChild(li);
      });

      // Single DOM update
      dropdownList.innerHTML = '';
      dropdownList.appendChild(fragment);

      // Select first option and set aria-activedescendant
      const firstOption = options[0];
      dropdownValue.textContent = firstOption.label;
      propertyTypeInput.value = firstOption.value;
      dropdownTrigger.setAttribute('aria-activedescendant', `property-option-${firstOption.value}`);
    }

    function selectOption(option, optionElement) {
      // Update value display
      dropdownValue.textContent = option.label;
      propertyTypeInput.value = option.value;

      // Update selected state
      const allOptions = dropdownList.querySelectorAll('.immo-search__dropdown-option');
      allOptions.forEach(opt => {
        opt.classList.remove('immo-search__dropdown-option--selected');
        opt.setAttribute('aria-selected', 'false');
      });
      optionElement.classList.add('immo-search__dropdown-option--selected');
      optionElement.setAttribute('aria-selected', 'true');

      // Update aria-activedescendant for screen readers
      dropdownTrigger.setAttribute('aria-activedescendant', optionElement.id);

      // Close dropdown
      closeDropdown();
    }

    function openDropdown() {
      dropdown.classList.add('immo-search__dropdown--open');
      dropdownTrigger.setAttribute('aria-expanded', 'true');
      focusedIndex = -1;
    }

    function closeDropdown() {
      dropdown.classList.remove('immo-search__dropdown--open');
      dropdownTrigger.setAttribute('aria-expanded', 'false');
      focusedIndex = -1;
      clearFocusedOption();
    }

    function toggleDropdown() {
      if (dropdown.classList.contains('immo-search__dropdown--open')) {
        closeDropdown();
      } else {
        openDropdown();
      }
    }

    function clearFocusedOption() {
      const options = dropdownList.querySelectorAll('.immo-search__dropdown-option');
      options.forEach(opt => opt.classList.remove('immo-search__dropdown-option--focused'));
    }

    function focusOption(index) {
      const options = dropdownList.querySelectorAll('.immo-search__dropdown-option');
      if (options.length === 0) return;

      clearFocusedOption();

      if (index < 0) index = options.length - 1;
      if (index >= options.length) index = 0;

      focusedIndex = index;
      options[focusedIndex].classList.add('immo-search__dropdown-option--focused');
    }

    dropdownTrigger.addEventListener('click', toggleDropdown);

    dropdownTrigger.addEventListener('keydown', (e) => {
      const options = dropdownList.querySelectorAll('.immo-search__dropdown-option');

      switch (e.key) {
        case 'Enter':
        case ' ':
          e.preventDefault();
          if (dropdown.classList.contains('immo-search__dropdown--open') && focusedIndex >= 0) {
            options[focusedIndex].click();
          } else {
            toggleDropdown();
          }
          break;
        case 'ArrowDown':
          e.preventDefault();
          if (!dropdown.classList.contains('immo-search__dropdown--open')) {
            openDropdown();
          }
          focusOption(focusedIndex + 1);
          break;
        case 'ArrowUp':
          e.preventDefault();
          if (!dropdown.classList.contains('immo-search__dropdown--open')) {
            openDropdown();
          }
          focusOption(focusedIndex - 1);
          break;
        case 'Escape':
          closeDropdown();
          dropdownTrigger.focus();
          break;
        case 'Tab':
          closeDropdown();
          break;
      }
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target)) {
        closeDropdown();
        dropdownTrigger.blur();
      }
    });

    // Initialize dropdown
    renderOptions('mieten');

    // Enable transitions after initial render (prevents animation on page load)
    requestAnimationFrame(() => {
      dropdown.classList.add('immo-search__dropdown--ready');
    });

    // ========================================
    // TYPING ANIMATION FOR SEARCH INPUT
    // Creates a typewriter effect in the placeholder text, cycling through
    // different search terms (Postleitzahl, Stadtteil, Ort).
    // Stops on focus, restarts on blur if input is empty.
    // ========================================

    const baseText = 'Suche nach';
    const typingPhrases = [' Postleitzahl', ' Stadtteil', ' Ort'];
    const errorMessage = 'Bitte Ort oder PLZ eingeben.';
    let phraseIndex = 0;
    let charIndex = 0;
    let isDeleting = false;
    let isTypingStopped = false;
    const typingSpeed = 60;
    const deletingSpeed = 40;
    const pauseBeforeDelete = 1000;
    const pauseBeforeType = 300;

    function animatePlaceholder() {
      if (isTypingStopped) return;

      const currentPhrase = typingPhrases[phraseIndex];
      const displayText = baseText + currentPhrase.substring(0, charIndex);
      zipCodeInput.setAttribute('placeholder', displayText);

      let nextDelay;

      if (!isDeleting) {
        if (charIndex < currentPhrase.length) {
          charIndex++;
          nextDelay = typingSpeed;
        } else {
          isDeleting = true;
          nextDelay = pauseBeforeDelete;
        }
      } else {
        if (charIndex > 0) {
          charIndex--;
          nextDelay = deletingSpeed;
        } else {
          isDeleting = false;
          phraseIndex = (phraseIndex + 1) % typingPhrases.length;
          nextDelay = pauseBeforeType;
        }
      }

      setTimeout(animatePlaceholder, nextDelay);
    }

    // Clear error state on user input
    zipCodeInput.addEventListener('input', function() {
      if (zipCodeInput.classList.contains('immo-search__input--error')) {
        // Clear the error message if user starts typing
        if (zipCodeInput.value.startsWith(errorMessage.substring(0, 5))) {
          zipCodeInput.value = '';
        }
        clearErrorState();
      }
    });

    // Stop placeholder typing animation on focus
    zipCodeInput.addEventListener('focus', function() {
      isTypingStopped = true;
      zipCodeInput.setAttribute('placeholder', '');
    });

    // Restart typing animation on blur if input is empty
    zipCodeInput.addEventListener('blur', function() {
      if (!zipCodeInput.value.trim() || zipCodeInput.value === errorMessage) {
        zipCodeInput.value = '';
        zipCodeInput.classList.remove('immo-search__input--error');
        if (errorTypingInterval) {
          clearInterval(errorTypingInterval);
          errorTypingInterval = null;
        }
        isTypingStopped = false;
        charIndex = 0;
        isDeleting = false;
        animatePlaceholder();
      }
    });

    // Start the typing animation
    animatePlaceholder();

    // Error live region element for screen reader announcements
    const zipCodeError = document.getElementById('zipCodeError');

    // Type error message letter by letter
    let errorCharIndex = 0;
    let errorTypingInterval = null;

    function typeErrorMessage() {
      if (errorCharIndex <= errorMessage.length) {
        zipCodeInput.value = errorMessage.substring(0, errorCharIndex);
        errorCharIndex++;
      } else {
        clearInterval(errorTypingInterval);
        errorTypingInterval = null;
      }
    }

    // Clear error state helper
    function clearErrorState() {
      zipCodeInput.classList.remove('immo-search__input--error');
      zipCodeInput.removeAttribute('aria-invalid');
      zipCodeError.textContent = '';
      if (errorTypingInterval) {
        clearInterval(errorTypingInterval);
        errorTypingInterval = null;
      }
    }

    // Form submission
    form.addEventListener('submit', function(e) {
      e.preventDefault();

      // Validate zipcode
      if (!zipCodeInput.value.trim() || zipCodeInput.value === errorMessage) {
        isTypingStopped = true;
        zipCodeInput.classList.add('immo-search__input--error');
        zipCodeInput.setAttribute('aria-invalid', 'true');
        zipCodeInput.focus();

        // Announce error to screen readers
        zipCodeError.textContent = errorMessage;

        // Start typing error message visually
        errorCharIndex = 0;
        zipCodeInput.value = '';
        if (errorTypingInterval) clearInterval(errorTypingInterval);
        errorTypingInterval = setInterval(typeErrorMessage, 30);
        return;
      }

      // Clear any previous error state
      clearErrorState();

      // Log form data into console
      console.log('Form submitted:', {
        transactionType: transactionTypeInput.value,
        propertyType: propertyTypeInput.value,
        propertyText: dropdownValue.textContent,
        zipCode: zipCodeInput.value
      });
    });
  });
</script>
</body>
</html>